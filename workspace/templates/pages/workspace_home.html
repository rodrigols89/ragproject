{% extends "base.html" %}
{% block title %}Workspace{% endblock %}

{% block content %}
    <div class="flex h-screen bg-gray-100">

        <!-- üß± Sidebar -->
        <aside class="w-64 bg-gray-900 text-white flex flex-col justify-between">

            <!-- Bot√£o de voltar para Home -->
            <div class="p-2 border-b border-gray-700">
                <a href="{% url 'home' %}"
                   class="flex items-center justify-between p-2 hover:bg-gray-800 rounded">
                    Home
                </a>
            </div>

            <!-- Logout -->
            <div class="p-4 border-t border-gray-700">
                <a href="{% url 'logout' %}"
                   class="block text-center text-red-400 hover:text-red-300">
                   Sair
                </a>
            </div>

        </aside>

        <!-- üíº √Årea principal do Workspace -->
        <main class="flex-1 p-8 overflow-y-auto">

            <!-- Header -->
            <header class="bg-white shadow px-6 py-4">
                <h1 class="text-2xl font-semibold text-gray-800">
                    Bem-vindo, {{ request.user.username }}!
                </h1>
            </header>

            <!-- üß≠ Breadcrumbs -->
            <nav class="text-sm text-gray-600 my-4 flex items-center space-x-2">

                {% if current_folder %}

                    {% if breadcrumbs|length > 1 %}
                        {% with prev_folder=breadcrumbs|slice:"-2:-1"|first %}
                            <a href="?folder={{ prev_folder.id }}"
                               class="text-blue-600 hover:underline breadcrumb-drop"
                               data-folder-id="{{ prev_folder.id }}">‚Üê Voltar</a>
                        {% endwith %}
                    {% else %}
                        <a href="{% url 'workspace_home' %}"
                           class="text-blue-600 hover:underline breadcrumb-drop"
                           data-folder-id="">‚Üê Voltar √† raiz</a>
                    {% endif %}

                    <span>/</span>

                    {% for folder in breadcrumbs %}
                        {% if not forloop.last %}
                            <a href="?folder={{ folder.id }}"
                               class="hover:underline breadcrumb-drop"
                               data-folder-id="{{ folder.id }}">{{ folder.name }}</a>
                            <span>/</span>
                        {% else %}
                            <span class="font-semibold breadcrumb-drop"
                                  data-folder-id="{{ folder.id }}">{{ folder.name }}
                            </span>
                        {% endif %}
                    {% endfor %}

                {% else %}
                    <span class="text-gray-400 italic breadcrumb-drop" data-folder-id="">üìÅ Raiz</span>
                {% endif %}

            </nav>

            <!-- Mensagens -->
            {% if messages %}
                <ul class="mb-4">
                    {% for message in messages %}
                        <li class="px-4 py-2 rounded 
                            {% if message.tags == 'success' %}bg-green-100 text-green-700
                            {% else %}bg-red-100 text-red-700{% endif %}">
                            {{ message }}
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}

            <!-- üìå Bot√µes -->
            <div class="mb-6 flex items-center gap-3 flex-wrap" data-preserve-selection="true">

                <button command="show-modal" commandfor="create_folder_modal"
                        class="inline-block
                               bg-green-600
                               hover:bg-green-700
                               text-white
                               px-4
                               py-2
                               rounded">
                    ‚ûï Nova Pasta
                </button>

                <form method="post"
                      action="{% url 'upload_file' %}"
                      enctype="multipart/form-data"
                      class="inline-block">

                    {% csrf_token %}

                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <input type="hidden" name="folder" value="{{ current_folder.id|default_if_none:'' }}">

                    <label class="inline-block bg-blue-600 hover:bg-blue-700
                                  text-white px-4 py-2 rounded cursor-pointer">
                        üì§ Fazer Upload
                        <input type="file" name="file" multiple class="hidden" onchange="this.form.submit()">
                    </label>

                </form>

                <button id="delete_selected"
                        class="inline-block bg-red-600 hover:bg-red-700
                               text-white px-4 py-2 rounded disabled:opacity-50
                               disabled:cursor-not-allowed"
                        disabled>
                    üóë Remover
                </button>

                <button id="rename_selected"
                        class="inline-block bg-yellow-500
                               hover:bg-yellow-600 text-white
                               px-4 py-2 rounded disabled:opacity-50
                               disabled:cursor-not-allowed"
                        disabled>
                    ‚úè Renomear
                </button>

                <form id="delete_form" method="post" class="hidden">
                    {% csrf_token %}
                </form>

                <dialog
                    id="rename_modal"
                    aria-labelledby="rename-title"
                    data-preserve-selection="true"
                    class="fixed inset-0 size-auto max-h-none
                           max-w-none overflow-y-auto bg-transparent
                           backdrop:bg-transparent">
                    <div tabindex="0"
                         class="flex min-h-full items-center
                                justify-center p-4 text-center
                                sm:p-0">
                        <div class="relative transform rounded-lg
                                    bg-white shadow-xl transition-all
                                    sm:w-full sm:max-w-md p-6">
                            <form id="rename_form" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                <h3 id="rename-title" class="text-lg font-semibold text-gray-900 mb-4">
                                    Renomear item
                                </h3>
                                <div>
                                    <label for="rename_input" class="block text-sm font-medium text-gray-700">
                                        Novo nome
                                    </label>
                                    <input type="text" id="rename_input" name="name" required
                                           class="mt-1 block w-full px-4 py-2 border rounded-lg"
                                           autocomplete="off">
                                </div>
                                <div class="mt-6 flex justify-end space-x-2">
                                    <button type="submit"
                                            class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded">
                                        Salvar
                                    </button>
                                    <button type="button" id="rename_cancel"
                                            class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded">
                                        Cancelar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </dialog>
            </div>

            <!-- MODAL Criar Pasta -->
            <el-dialog>
                <dialog
                    id="create_folder_modal"
                    aria-labelledby="modal-title"
                    class="fixed inset-0 size-auto max-h-none
                           max-w-none overflow-y-auto
                           bg-transparent backdrop:bg-transparent">
                    <el-dialog-backdrop class="fixed inset-0 bg-gray-900/50 transition-opacity"></el-dialog-backdrop>

                    <div tabindex="0"
                        class="flex min-h-full items-center
                               justify-center p-4 text-center sm:p-0">
                        <el-dialog-panel
                            class="relative transform rounded-lg
                                   bg-white shadow-xl transition-all
                                   sm:w-full sm:max-w-md p-6">
                            <form method="post" action="{% url 'create_folder' %}">
                                {% csrf_token %}
                                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                <input type="hidden" name="parent" value="{{ current_folder.id|default_if_none:'' }}">

                                <h3 id="modal-title" class="text-lg font-semibold text-gray-900 mb-4">
                                    Criar nova pasta
                                </h3>

                                <div>
                                    <label for="nome_pasta" class="block text-sm font-medium text-gray-700">
                                        Nome da pasta
                                    </label>
                                    <input type="text" name="name" id="nome_pasta" required
                                        class="mt-1 block w-full px-4 py-2 border rounded-lg"
                                        autocomplete="off"
                                        value="{{ form.name.value|default:'' }}">

                                    {% if form.name.errors %}
                                        <p id="server-error" class="text-sm text-red-500 mt-1">{{ form.name.errors.0 }}</p>
                                    {% else %}
                                        <p id="server-error" class="text-sm text-red-500 mt-1 hidden"></p>
                                    {% endif %}
                                </div>

                                <div class="mt-6 flex justify-end space-x-2">

                                    <button type="submit" id="create_folder_btn"
                                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded">
                                        Criar
                                    </button>

                                    <button type="button" command="close" commandfor="create_folder_modal"
                                            class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded">
                                        Cancelar
                                    </button>
                                </div>
                            </form>
                        </el-dialog-panel>
                    </div>
                </dialog>

                {% if show_modal %}
                    <script>
                        document.addEventListener("DOMContentLoaded", function () {
                            const dlg = document.querySelector("#create_folder_modal");
                            dlg.showModal();
                            const input = dlg.querySelector("#nome_pasta");
                            if (input) {
                                setTimeout(() => { input.focus(); input.select(); }, 0);
                            }
                        });
                    </script>
                {% endif %}
            </el-dialog>

            <!-- üìÅ Listagem -->
            {% if folders or files %}
                <ul class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">

                    <!-- Pastas -->
                    {% for folder in folders %}
                        <li class="bg-white border rounded-lg p-4 hover:shadow-md
                                   transition cursor-pointer selectable-item"
                            data-url="?folder={{ folder.id }}" data-target="_self"
                            data-kind="folder" data-id="{{ folder.id }}" draggable="true">
                            <div class="block">
                                <span class="text-gray-800
                                             font-semibold flex
                                             items-center space-x-2">
                                    <span>üìÅ</span>
                                    <span>{{ folder.name }}</span>
                                </span>
                            </div>
                        </li>
                    {% endfor %}

                    <!-- Arquivos -->
                    {% for file in files %}
                        <li
                            class="bg-white border rounded-lg p-4 hover:shadow-md
                                   transition cursor-pointer selectable-item"
                            data-url="{{ file.file.url }}" data-target="_blank"
                            data-kind="file" data-id="{{ file.id }}" draggable="true">
                            <div class="block">
                                <span class="text-gray-800 font-semibold flex items-center space-x-2">
                                    <span>üìÑ</span>
                                    <span>{{ file.name }}</span>
                                </span>
                                <p class="text-xs text-gray-500">
                                    Enviado em {{ file.uploaded_at|date:"d/m/Y H:i" }}
                                    ({{ file.file.size|filesizeformat }})
                                </p>
                            </div>
                        </li>
                    {% endfor %}

                </ul>
            {% else %}
                <p class="pt-4 text-gray-500 italic">Nenhum item encontrado neste diret√≥rio.</p>
            {% endif %}

        </main>

    </div>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const modal = document.querySelector("#create_folder_modal");
            const input = modal.querySelector("#nome_pasta");
            const serverError = document.getElementById("server-error");
            const openCreateBtn = document.querySelector('button[command="show-modal"][commandfor="create_folder_modal"]');
            const cancelButtons = modal.querySelectorAll("button[command='close']");
            const deleteButton = document.getElementById("delete_selected");
            const deleteForm = document.getElementById("delete_form");
            const renameButton = document.getElementById("rename_selected");
            const renameModal = document.getElementById("rename_modal");
            const renameForm = document.getElementById("rename_form");
            const renameInput = document.getElementById("rename_input");
            const renameCancel = document.getElementById("rename_cancel");
            const breadcrumbDrops = document.querySelectorAll(".breadcrumb-drop");
            const moveEndpoint = "{% url 'move_item' %}";
            const csrfToken = deleteForm.querySelector("input[name='csrfmiddlewaretoken']").value;

            function clearModalFields() {
                input.value = "";
                serverError.textContent = "";
                serverError.classList.add("hidden");
            }

            function focusCreateInput() {
                // timeout garante foco ap√≥s showModal
                setTimeout(() => {
                    input.focus();
                    input.select();
                }, 0);
            }

            cancelButtons.forEach(btn => {
                btn.addEventListener("click", function () {
                    clearModalFields();
                    modal.close();
                    if (window.location.pathname.startsWith("/create-folder")) {
                        window.location.href = "/workspace";
                    }
                });
            });

            modal.addEventListener("cancel", function () {
                clearModalFields();
                    modal.close();
                    if (window.location.pathname.startsWith("/create-folder")) {
                        window.location.href = "/workspace";
                    }
            });

            if (openCreateBtn) {
                openCreateBtn.addEventListener("click", (event) => {
                    event.preventDefault();
                    modal.showModal();
                    focusCreateInput();
                });
            }

            // ---------------------------
            // Sele√ß√£o com 1 clique; abrir com 2 cliques
            // ---------------------------
            const selectableItems = document.querySelectorAll(".selectable-item");

            let selectedItem = null;
            let draggedItem = null;

            function clearSelection() {
                selectableItems.forEach(el => el.classList.remove("ring-2", "ring-blue-500"));
                selectedItem = null;
                deleteButton.disabled = true;
                renameButton.disabled = true;
            }

            function selectItem(item) {
                selectableItems.forEach(el => el.classList.remove("ring-2", "ring-blue-500"));
                item.classList.add("ring-2", "ring-blue-500");
                selectedItem = item;
                deleteButton.disabled = false;
                renameButton.disabled = false;
            }

            function moveSelectedToFolder(targetFolderId) {
                if (!selectedItem) return;
                const payload = new URLSearchParams({
                    item_type: selectedItem.dataset.kind,
                    item_id: selectedItem.dataset.id,
                    target_folder: targetFolderId || "",
                });

                fetch(moveEndpoint, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": csrfToken,
                    },
                    body: payload,
                })
                    .then(async response => {
                        const data = await response.json().catch(() => ({}));
                        if (!response.ok) {
                            const message = data.error || "N√£o foi poss√≠vel mover o item.";
                            alert(message);
                            return;
                        }
                        window.location.reload();
                    })
                    .catch(() => alert("Erro inesperado ao mover item."));
            }

            selectableItems.forEach(item => {
                item.addEventListener("click", (event) => {
                    event.preventDefault();
                    selectItem(item);
                });

                item.addEventListener("dblclick", () => {
                    const url = item.dataset.url;
                    const target = item.dataset.target || "_self";
                    if (!url) return;

                    if (target === "_blank") {
                        window.open(url, "_blank");
                    } else {
                        window.location.href = url;
                    }
                });

                item.addEventListener("dragstart", (event) => {
                    draggedItem = item;
                    event.dataTransfer.effectAllowed = "move";
                    if (selectedItem !== item) {
                        selectItem(item);
                    }
                });

                item.addEventListener("dragend", () => {
                    draggedItem = null;
                    document.querySelectorAll(".drop-highlight").forEach(el => el.classList.remove("ring-2", "ring-green-500"));
                });

                if (item.dataset.kind === "folder") {
                    item.addEventListener("dragover", (event) => {
                        if (draggedItem && draggedItem !== item) {
                            event.preventDefault();
                            item.classList.add("ring-2", "ring-green-500", "drop-highlight");
                        }
                    });

                    item.addEventListener("dragleave", () => {
                        item.classList.remove("ring-2", "ring-green-500", "drop-highlight");
                    });

                    item.addEventListener("drop", (event) => {
                        event.preventDefault();
                        item.classList.remove("ring-2", "ring-green-500", "drop-highlight");
                        if (!draggedItem || draggedItem === item) return;
                        moveSelectedToFolder(item.dataset.id);
                    });
                }
            });

            deleteButton.addEventListener("click", (event) => {
                event.preventDefault();
                if (!selectedItem) return;

                const kind = selectedItem.dataset.kind;
                const id = selectedItem.dataset.id;
                if (!kind || !id) return;

                let action = "";
                if (kind === "folder") {
                    action = `/delete-folder/${id}/`;
                } else if (kind === "file") {
                    action = `/delete-file/${id}/`;
                }

                if (action) {
                    deleteForm.action = action;
                    deleteForm.submit();
                }
            });

            renameButton.addEventListener("click", (event) => {
                event.preventDefault();
                if (!selectedItem) return;
                const currentName = selectedItem.querySelector("span:nth-child(2)")?.textContent?.trim() || "";
                renameInput.value = currentName;
                renameModal.showModal();
                renameInput.focus();
            });

            renameCancel.addEventListener("click", () => {
                renameModal.close();
            });

            renameForm.addEventListener("submit", (event) => {
                if (!selectedItem) {
                    event.preventDefault();
                    return;
                }
                const kind = selectedItem.dataset.kind;
                const id = selectedItem.dataset.id;
                if (!kind || !id) {
                    event.preventDefault();
                    return;
                }
                if (kind === "folder") {
                    renameForm.action = `/rename-folder/${id}/`;
                } else if (kind === "file") {
                    renameForm.action = `/rename-file/${id}/`;
                } else {
                    event.preventDefault();
                }
            });

            // Esc limpa a sele√ß√£o
            document.addEventListener("keydown", (event) => {
                if (event.key === "Escape") {
                    clearSelection();
                }
            });

            // Clique fora de itens limpa sele√ß√£o
            document.addEventListener("click", (event) => {
                const clickedItem = event.target.closest(".selectable-item");
                const preserve = event.target.closest("[data-preserve-selection='true']");
                if (!clickedItem && !preserve) {
                    clearSelection();
                }
            }, true);

            breadcrumbDrops.forEach(crumb => {
                crumb.addEventListener("dragover", (event) => {
                    if (!draggedItem) return;
                    event.preventDefault();
                    crumb.classList.add("ring-2", "ring-green-500", "drop-highlight");
                });

                crumb.addEventListener("dragleave", () => {
                    crumb.classList.remove("ring-2", "ring-green-500", "drop-highlight");
                });

                crumb.addEventListener("drop", (event) => {
                    event.preventDefault();
                    crumb.classList.remove("ring-2", "ring-green-500", "drop-highlight");
                    if (!draggedItem) return;
                    moveSelectedToFolder(crumb.dataset.folderId || null);
                });
            });
        });
    </script>
{% endblock scripts %}
