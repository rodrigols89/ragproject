{% extends "base.html" %}
{% load static %}
{% block title %}Workspace{% endblock %}

{% block content %}
    <div class="flex h-screen bg-gray-100">

        <!-- üß± Sidebar -->
        <aside class="w-64 bg-gray-900 text-white flex flex-col justify-between">

            <!-- Bot√£o de voltar para Home -->
            <div class="p-2 border-b border-gray-700">
                <a href="{% url 'home' %}"
                   class="flex items-center justify-between 
                          p-2 hover:bg-gray-800 rounded">
                    Home
                </a>
            </div>

            <!-- Logout -->
            <div class="p-4 border-t border-gray-700">
                <a href="{% url 'logout' %}"
                   class="block text-center text-red-400 
                          hover:text-red-300">
                   Sair
                </a>
            </div>

        </aside>

        <!-- üíº √Årea principal do Workspace -->
        <main class="flex-1 p-8 overflow-y-auto">

            <!-- Header -->
            <header class="bg-white shadow px-6 py-4">
                <h1 class="text-2xl font-semibold text-gray-800">
                    Bem-vindo, {{ request.user.username }}!
                </h1>
            </header>

            <!-- üß≠ Breadcrumbs -->
            <nav class="text-sm text-gray-600 my-4 flex items-center space-x-2">

                {% if current_folder %}

                    {% if breadcrumbs|length > 1 %}
                        {% with prev_folder=breadcrumbs|slice:"-2:-1"|first %}
                            <a href="?folder={{ prev_folder.id }}"
                               class="text-blue-600 hover:underline breadcrumb-drop"
                               data-folder-id="{{ prev_folder.id }}">‚Üê Voltar</a>
                        {% endwith %}
                    {% else %}
                        <a href="{% url 'workspace_home' %}"
                           class="text-blue-600 hover:underline breadcrumb-drop"
                           data-folder-id="">‚Üê Voltar √† raiz</a>
                    {% endif %}

                    <span>/</span>

                    {% for folder in breadcrumbs %}
                        {% if not forloop.last %}
                            <a href="?folder={{ folder.id }}"
                               class="hover:underline breadcrumb-drop"
                               data-folder-id="{{ folder.id }}">{{ folder.name }}</a>
                            <span>/</span>
                        {% else %}
                            <span class="font-semibold breadcrumb-drop"
                                  data-folder-id="{{ folder.id }}">{{ folder.name }}
                            </span>
                        {% endif %}
                    {% endfor %}

                {% else %}
                    <span class="text-gray-400 italic breadcrumb-drop" data-folder-id="">
                        üìÅ Raiz
                    </span>
                {% endif %}

            </nav>

            <!-- Mensagens -->
            {% if messages %}
                <ul class="mb-4">
                    {% for message in messages %}
                        <li class="px-4 py-2 rounded 
                            {% if message.tags == 'success' %}
                                bg-green-100 text-green-700
                            {% else %}bg-red-100 text-red-700{% endif %}">
                                {{ message }}
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}

            <!-- üìå Bot√µes -->
            <div class="mb-6 flex items-center gap-3 flex-wrap" data-preserve-selection="true">

                <button 
                    command="show-modal" 
                    commandfor="create_folder_modal"
                    class="inline-block
                           bg-green-600
                           hover:bg-green-700
                           text-white
                           px-4
                           py-2
                           rounded">
                    ‚ûï Nova Pasta
                </button>

                <!-- Dropdown de Upload -->
                <div class="relative inline-block">
                    <button 
                        type="button"
                        id="upload_button"
                        class="inline-block bg-blue-600 hover:bg-blue-700
                               text-white px-4 py-2 rounded cursor-pointer">
                        üì§ Fazer Upload
                    </button>
                    
                    <div id="upload_menu" 
                         class="hidden absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg z-50 border border-gray-200">
                        <div class="py-1">
                            <label for="file_input" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">
                                üìÑ Arquivo
                            </label>
                            <button type="button" id="open_folder_upload_modal" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">
                                üìÅ Pasta
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modal para upload de pasta -->
                <dialog
                    id="upload_folder_modal"
                    aria-labelledby="upload-folder-title"
                    class="fixed inset-0 size-auto max-h-none
                           max-w-none overflow-y-auto bg-transparent
                           backdrop:bg-transparent">
                    <div tabindex="0"
                         class="flex min-h-full items-center
                                justify-center p-4 text-center
                                sm:p-0">
                        <div class="relative transform rounded-lg
                                    bg-white shadow-xl transition-all
                                    sm:w-full sm:max-w-md p-6">
                            <h3 id="upload-folder-title" class="text-lg font-semibold text-gray-900 mb-4">
                                Fazer Upload de Pasta
                            </h3>
                            <p class="text-sm text-gray-600 mb-4">
                                Selecione a pasta que deseja fazer upload.
                                O nome da pasta ser√° detectado automaticamente.
                            </p>
                            <form id="upload_folder_modal_form" method="post"
                                  action="{% url 'upload_folder' %}"
                                  enctype="multipart/form-data">
                                {% csrf_token %}
                                <input 
                                    type="hidden" 
                                    name="next" 
                                    value="{{ request.get_full_path }}">
                                <input 
                                    type="hidden" 
                                    name="folder" 
                                    value="{{ current_folder.id|default_if_none:'' }}">
                                
                                <div class="mb-4">
                                    <label for="folder_input_modal" class="block text-sm font-medium text-gray-700 mb-2">
                                        Selecionar pasta
                                    </label>
                                    <input 
                                        type="file" 
                                        name="files" 
                                        id="folder_input_modal"
                                        webkitdirectory 
                                        directory 
                                        multiple 
                                        class="block w-full text-sm text-gray-500
                                               file:mr-4 file:py-2 file:px-4
                                               file:rounded-full file:border-0
                                               file:text-sm file:font-semibold
                                               file:bg-blue-50 file:text-blue-700
                                               hover:file:bg-blue-100"
                                        required>
                                    <input 
                                        type="hidden" 
                                        name="folder_name" 
                                        id="detected_folder_name">
                                </div>

                                <div class="flex justify-end space-x-2">
                                    <button type="button" id="cancel_folder_upload"
                                            class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded">
                                        Cancelar
                                    </button>
                                    <button type="submit"
                                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">
                                        Fazer Upload
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </dialog>

                <!-- Formul√°rio para upload de arquivo -->
                <form method="post"
                      id="upload_file_form"
                      action="{% url 'upload_file' %}"
                      enctype="multipart/form-data"
                      class="hidden">

                    {% csrf_token %}

                    <input 
                        type="hidden" 
                        name="next" 
                        value="{{ request.get_full_path }}">
                    <input 
                        type="hidden" 
                        name="folder" 
                        value="{{ current_folder.id|default_if_none:'' }}">
                    <input 
                        type="hidden" 
                        name="upload_type" 
                        value="file">
                    <input 
                        type="file" 
                        name="file" 
                        id="file_input"
                        multiple 
                        class="hidden" 
                        onchange="this.form.submit()">
                </form>


                <button id="delete_selected"
                        class="inline-block bg-red-600 hover:bg-red-700
                               text-white px-4 py-2 rounded disabled:opacity-50
                               disabled:cursor-not-allowed"
                        disabled>
                    üóë Remover
                </button>

                <button id="rename_selected"
                        class="inline-block bg-yellow-500
                               hover:bg-yellow-600 text-white
                               px-4 py-2 rounded disabled:opacity-50
                               disabled:cursor-not-allowed"
                        disabled>
                    ‚úè Renomear
                </button>

                <form id="delete_form" method="post" class="hidden">
                    {% csrf_token %}
                </form>

                <!-- Configura√ß√£o para JavaScript -->
                <div data-workspace-config 
                     data-move-endpoint="{% url 'move_item' %}"
                     style="display: none;">
                </div>

                <dialog
                    id="rename_modal"
                    aria-labelledby="rename-title"
                    data-preserve-selection="true"
                    class="fixed inset-0 size-auto max-h-none
                           max-w-none overflow-y-auto bg-transparent
                           backdrop:bg-transparent">
                    <div tabindex="0"
                         class="flex min-h-full items-center
                                justify-center p-4 text-center
                                sm:p-0">
                        <div class="relative transform rounded-lg
                                    bg-white shadow-xl transition-all
                                    sm:w-full sm:max-w-md p-6">
                            <form id="rename_form" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                <h3 id="rename-title" class="text-lg font-semibold text-gray-900 mb-4">
                                    Renomear item
                                </h3>
                                <div>
                                    <label for="rename_input" class="block text-sm font-medium text-gray-700">
                                        Novo nome
                                    </label>
                                    <input type="text" id="rename_input" name="name" required
                                           class="mt-1 block w-full px-4 py-2 border rounded-lg"
                                           autocomplete="off">
                                </div>
                                <div class="mt-6 flex justify-end space-x-2">
                                    <button type="submit"
                                            class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded">
                                        Salvar
                                    </button>
                                    <button type="button" id="rename_cancel"
                                            class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded">
                                        Cancelar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </dialog>
            </div>

            <!-- MODAL Criar Pasta -->
            <el-dialog>
                <dialog
                    id="create_folder_modal"
                    aria-labelledby="modal-title"
                    {% if show_modal %}data-auto-open="true"{% endif %}
                    class="fixed inset-0 size-auto max-h-none
                           max-w-none overflow-y-auto
                           bg-transparent backdrop:bg-transparent">

                    <el-dialog-backdrop class="fixed inset-0 bg-gray-900/50 transition-opacity"></el-dialog-backdrop>

                    <div tabindex="0"
                        class="flex min-h-full items-center
                               justify-center p-4 text-center sm:p-0">
                        <el-dialog-panel
                            class="relative transform rounded-lg
                                   bg-white shadow-xl transition-all
                                   sm:w-full sm:max-w-md p-6">
                            <form method="post" action="{% url 'create_folder' %}">
                                {% csrf_token %}
                                <input 
                                    type="hidden" 
                                    name="next" 
                                    value="{{ request.get_full_path }}">
                                <input
                                    type="hidden" 
                                    name="parent" 
                                    value="{{ current_folder.id|default_if_none:'' }}">

                                <h3 id="modal-title" class="text-lg font-semibold text-gray-900 mb-4">
                                    Criar nova pasta
                                </h3>

                                <div>
                                    <label for="nome_pasta" class="block text-sm font-medium text-gray-700">
                                        Nome da pasta
                                    </label>
                                    <input type="text" name="name" id="nome_pasta" required
                                        class="mt-1 block w-full px-4 py-2 border rounded-lg"
                                        autocomplete="off"
                                        value="{{ form.name.value|default:'' }}">

                                    {% if form.name.errors %}
                                        <p id="server-error" class="text-sm text-red-500 mt-1">
                                            {{ form.name.errors.0 }}
                                        </p>
                                    {% else %}
                                        <p id="server-error" class="text-sm text-red-500 mt-1 hidden"></p>
                                    {% endif %}
                                </div>

                                <div class="mt-6 flex justify-end space-x-2">

                                    <button type="submit" id="create_folder_btn"
                                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded">
                                        Criar
                                    </button>

                                    <button type="button" command="close" commandfor="create_folder_modal"
                                            class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded">
                                        Cancelar
                                    </button>
                                </div>
                            </form>
                        </el-dialog-panel>
                    </div>
                </dialog>

            </el-dialog>

            <!-- üìÅ Listagem -->
            {% if folders or files %}
                <ul class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">

                    <!-- Pastas -->
                    {% for folder in folders %}
                        <li class="bg-white border rounded-lg p-4 hover:shadow-md
                                   transition cursor-pointer selectable-item"
                            data-url="?folder={{ folder.id }}" data-target="_self"
                            data-kind="folder" data-id="{{ folder.id }}" draggable="true">
                            <div class="block">
                                <span class="text-gray-800
                                             font-semibold flex
                                             items-center space-x-2">
                                    <span>üìÅ</span>
                                    <span>{{ folder.name }}</span>
                                </span>
                            </div>
                        </li>
                    {% endfor %}

                    <!-- Arquivos -->
                    {% for file in files %}
                        <li
                            class="bg-white border rounded-lg p-4 hover:shadow-md
                                   transition cursor-pointer selectable-item"
                            data-url="{{ file.file.url }}" data-target="_blank"
                            data-kind="file" data-id="{{ file.id }}" draggable="true">
                            <div class="block">
                                <span class="text-gray-800 font-semibold flex items-center space-x-2">
                                    <span>üìÑ</span>
                                    <span>{{ file.name }}</span>
                                </span>
                                <p class="text-xs text-gray-500">
                                    Enviado em {{ file.uploaded_at|date:"d/m/Y H:i" }}
                                    ({{ file.file.size|filesizeformat }})
                                </p>
                            </div>
                        </li>
                    {% endfor %}

                </ul>
            {% else %}
                <p class="pt-4 text-gray-500 italic">Nenhum item encontrado neste diret√≥rio.</p>
            {% endif %}

        </main>

    </div>
{% endblock %}

{% block scripts %}
    <script src="{% static 'workspace/js/workspace_home.js' %}"></script>
    <script>
        // Script adicional para garantir que o dropdown e modal funcionem
        (function() {
            function initUploadDropdown() {
                const btn = document.getElementById('upload_button');
                const menu = document.getElementById('upload_menu');
                
                if (btn && menu) {
                    btn.onclick = function(e) {
                        e.stopPropagation();
                        menu.classList.toggle('hidden');
                    };
                    
                    // Fecha ao clicar fora
                    setTimeout(function() {
                        document.addEventListener('click', function(e) {
                            if (btn && menu && 
                                !btn.contains(e.target) && 
                                !menu.contains(e.target)) {
                                menu.classList.add('hidden');
                            }
                        });
                    }, 300);
                }
            }
            
            function initFolderUploadModal() {
                const openBtn = document.getElementById('open_folder_upload_modal');
                const modal = document.getElementById('upload_folder_modal');
                const cancelBtn = document.getElementById('cancel_folder_upload');
                
                if (openBtn && modal) {
                    openBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const uploadMenu = document.getElementById('upload_menu');
                        if (uploadMenu) {
                            uploadMenu.classList.add('hidden');
                        }
                        modal.showModal();
                    });
                }
                
                if (cancelBtn && modal) {
                    cancelBtn.addEventListener('click', function() {
                        modal.close();
                    });
                }
                
                // Fecha o modal ao pressionar ESC
                if (modal) {
                    modal.addEventListener('cancel', function() {
                        modal.close();
                    });
                }
                
                // Detecta o nome da pasta quando arquivos s√£o selecionados
                const folderInput = document.getElementById('folder_input_modal');
                const folderNameInput = document.getElementById('detected_folder_name');
                
                if (folderInput && folderNameInput) {
                    folderInput.addEventListener('change', function(e) {
                        const files = e.target.files;
                        if (files && files.length > 0) {
                            // Tenta extrair o nome da pasta do caminho do primeiro arquivo
                            // O caminho pode incluir o nome da pasta selecionada
                            const firstFile = files[0];
                            const filePath = firstFile.webkitRelativePath || firstFile.name;
                            const pathParts = filePath.split('/');
                            
                            // Se o arquivo tem um caminho, a primeira parte pode ser o
                            // nome da pasta ou pode ser uma subpasta. Vamos verificar
                            // todos os arquivos.
                            const firstDirs = new Set();
                            for (let i = 0; i < files.length; i++) {
                                const file = files[i];
                                const path = file.webkitRelativePath || file.name;
                                const parts = path.split('/');
                                if (parts.length > 1 && parts[0].trim()) {
                                    firstDirs.add(parts[0].trim());
                                }
                            }
                            
                            // Se todos os arquivos compartilham o mesmo primeiro
                            // diret√≥rio, esse √© o nome da pasta
                            if (firstDirs.size === 1) {
                                folderNameInput.value = Array.from(firstDirs)[0];
                            } else if (firstDirs.size > 1) {
                                // M√∫ltiplos diret√≥rios - usa o primeiro encontrado
                                folderNameInput.value = pathParts[0];
                            } else {
                                // Arquivos na raiz da pasta selecionada - n√£o temos o nome
                                // O backend vai usar um nome padr√£o
                                folderNameInput.value = '';
                            }
                        }
                    });
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    initUploadDropdown();
                    initFolderUploadModal();
                });
            } else {
                initUploadDropdown();
                initFolderUploadModal();
            }
        })();
    </script>
{% endblock scripts %}
